{% extends 'core/blocks/base.html' %}
{% load static %}

{% block content %}
<h2>Add Piece</h2>

<form method="POST" action="">
  {% csrf_token %}

  <label for="date">Date:</label><br>
  <input type="date" id="date" name="date" required><br><br>

  <label for="weaver_select">Select Weaver:</label><br>
  <select id="weaver_select" name="weaver_id" required>
    <option value="">-- Select Weaver --</option>
    {% for weaver in weavers %}
      <option value="{{ weaver.user.username }}">{{ weaver.user.username }}</option>
    {% endfor %}
  </select><br><br>

  <div id="entries" style="display: none;">
    <div class="entry-group">
      <select name="warp_id[]" class="warp-select" required onchange="updateLength(this)">
  <option value="">-- Select Warp --</option>
  {% for warp in warp_list %}
    
    <option value="{{ warp.id }}" data-weaver="{{ warp.weaver.username }}" data-length="{{ warp.length }}">
      {{ warp.name }} | {{ warp.weaver.username }}
    </option>
   
  {% endfor %}
</select>

      <input type="number" step="0.01" name="length[]" class="length-input" placeholder="Length">
      <input type="number" step="0.01" name="count[]" placeholder="Count" required>

      <select name="type[]" required>
        <option value="good">Good</option>
        <option value="damage">Damage</option>
        <option value="return">Return</option>
        <option value="extra">Extra</option>
      </select>

      <button type="button" onclick="removeRow(this)">X</button>
    </div>
  </div>

  <button type="button" class="add-btn" id="add_row_btn" style="display: none;" onclick="addRow()">+ Add More</button>
  <br><br>
  <button type="submit">Submit</button>
</form>

<script>
  document.getElementById('date').valueAsDate = new Date();
  const weaverSelect = document.getElementById('weaver_select');
  const entriesDiv = document.getElementById('entries');
  const addRowBtn = document.getElementById('add_row_btn');

  weaverSelect.addEventListener('change', function () {
    const selectedWeaver = this.value;

    if (selectedWeaver) {
      entriesDiv.style.display = 'block';
      addRowBtn.style.display = 'inline-block';
    } else {
      entriesDiv.style.display = 'none';
      addRowBtn.style.display = 'none';
    }

    // Filter warp options in all rows
    document.querySelectorAll('.warp-select').forEach(select => {
      Array.from(select.options).forEach(option => {
        if (option.value === "") {
          option.style.display = 'block';
        } else {
          option.style.display = (option.dataset.weaver === selectedWeaver) ? 'block' : 'none';
        }
      });
      select.selectedIndex = 0;
      updateLength(select);
    });
  });

  function updateLength(selectElement) {
    const selectedOption = selectElement.selectedOptions[0];
    const length = selectedOption ? selectedOption.dataset.length : '';
    const parent = selectElement.closest('.entry-group');
    const lengthInput = parent.querySelector('.length-input');
    lengthInput.value = length || '';
  }

  function addRow() {
    const container = document.getElementById('entries');
    const newRow = container.firstElementChild.cloneNode(true);

    newRow.querySelectorAll('input').forEach(input => input.value = '');
    const select = newRow.querySelector('.warp-select');
    select.selectedIndex = 0;

    container.appendChild(newRow);
    filterWarpOptions(select);
  }

  function removeRow(button) {
    const container = document.getElementById('entries');
    if (container.children.length > 1) {
      button.parentElement.remove();
    }
  }

  function filterWarpOptions(select) {
    const selectedWeaver = weaverSelect.value;
    Array.from(select.options).forEach(option => {
      if (option.value === "") {
        option.style.display = 'block';
      } else {
        option.style.display = (option.dataset.weaver === selectedWeaver) ? 'block' : 'none';
      }
    });
    updateLength(select);
  }

  // On page load
  window.onload = function () {
    document.querySelectorAll('.warp-select').forEach(select => {
      filterWarpOptions(select);
    });
  };
</script>


{% endblock %}