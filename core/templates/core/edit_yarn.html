{% extends 'core/blocks/base.html' %}
{% block title %}Edit Yarn Transaction{% endblock %}

{% block content %}
<h1>Edit Yarn Transaction</h1>

{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<form method="POST" action="{% url 'edit_yarn' transaction.id %}">
  {% csrf_token %}

  <label for="yarn_id">Select Yarn:</label>
  <select name="yarn_id" id="yarn_id" required>
    <option value="">-- Select Yarn --</option>
    {% for yarn in yarns %}
      <option value="{{ yarn.id }}" {% if transaction.yarn.id == yarn.id %}selected{% endif %}>
        {{ yarn.color }} | {{ yarn.count }}<sup>s</sup>
      </option>
    {% endfor %}
  </select>

  <div id="staff-field">
    <label for="staff_select">Select Staff:</label>
    <select name="staff_select" id="staff_select">
      <option value="">-- Select Staff --</option>
      {% for s in staff %}
              <option value="{{ s.user.id }}"
        data-role="{{ s.role }}"
        {% if transaction.to == s.role and transaction.warp %}
          {% if transaction.warp.weaver.id == s.user.id or transaction.warp.warper.id == s.user.id %}
            selected
          {% endif %}
        {% endif %}>
        {{ s.user.username }} ({{ s.role }})
      </option>

      {% endfor %}
    </select>
  </div>


  <label for="date">Date:</label>
  <input type="date" name="date" id="date" value="{{ transaction.date|date:'Y-m-d' }}" required>

  <label for="transaction_type">Type:</label>
  <select name="transaction_type" id="transaction_type" required>
    <option value="give" {% if transaction.transaction_type == 'give' %}selected{% endif %}>Give</option>
    <option value="buy" {% if transaction.transaction_type == 'buy' %}selected{% endif %}>Buy</option>
  </select>

  <div id="note-field">
    <label for="note">Note:</label>
    <input type="text" name="note" id="note" value="{{ transaction.note|default_if_none:'' }}">
  </div>

  <div id="warp-field">
    <label for="warp_select">Select Warp:</label>
    <select name="warp_select" id="warp_select">
      <option value="">-- Select Warp --</option>
    </select>
  </div>

  <label for="quantity">Quantity:</label>
  <input type="number" step="0.01" name="quantity" id="quantity" value="{{ transaction.quantity }}" required>

  <button type="submit">Update</button>
  <button type="submit" name="delete_yarn" onclick="return confirm('Are you sure you want to delete this transaction?');" style="background:red;color:white;">Delete</button>
</form>

{{ warp_data|json_script:"warp-data" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const typeField = document.getElementById('transaction_type');
  const noteField = document.getElementById('note-field');
  const staffField = document.getElementById('staff-field');
  const warpField = document.getElementById('warp-field');
  const staffSelect = document.getElementById('staff_select');
  const warpSelect = document.getElementById('warp_select');
  const warpData = JSON.parse(document.getElementById('warp-data').textContent);
  const initialWarpId = "{{ transaction.warp.id|default_if_none:'' }}";

  function toggleFields() {
    if (typeField.value === 'buy') {
      noteField.style.display = 'block';
      staffField.style.display = 'none';
      warpField.style.display = 'none';
    } else {
      noteField.style.display = 'none';
      staffField.style.display = 'block';
      warpField.style.display = 'block';
    }
  }

  function populateWarps(staffId) {
    warpSelect.innerHTML = '<option value="">-- Select Warp --</option>';
    warpData.forEach(warp => {
      if (warp.weaver_id == staffId || warp.warper_id == staffId) {
        const opt = document.createElement('option');
        opt.value = warp.id;
        opt.textContent = warp.name || `Warp #${warp.id}`;
        warpSelect.appendChild(opt);
      }
    });
    if (initialWarpId) {
      warpSelect.value = initialWarpId;
    }
  }

  typeField.addEventListener('change', toggleFields);
  staffSelect.addEventListener('change', () => {
    populateWarps(staffSelect.value);
  });

  toggleFields();
  if (staffSelect.value) {
    populateWarps(staffSelect.value);
  }
});
</script>
{% endblock %}
